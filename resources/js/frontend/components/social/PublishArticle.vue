<template>
    <div class="multi-step-form" style="max-width: 100vw;">
        <div class="multi-form py-3 mx-3">
            <div class="inner">
                <ul class="steps p-0" @click="onClickListener($event)">
                    <!-- Step 1 - ç·¨è¼¯æ–‡ç« å…§å®¹ Start -->
                    <li ref="listItem" class="listItem show">
                        <div class="col1">
                            <span class="step">
                                <span>1</span>
                                <span class="checkmark"></span>
                            </span>
                            <span class="line"></span>
                        </div>
                        <div ref="stepBody" class="col2 stepBody">
                            <div class="stepTitle">
                                Step 1 - ç·¨è¼¯æ–‡ç« å…§å®¹
                            </div>
                            <div class="content">
                                <div class="inputGroup">
                                    <label for="name">è·Ÿå¤§å®¶åˆ†äº«ä½ çš„é åŒ—äº‹å§ã€‚</label>
                                    <textarea
                                        class="form-control cards-editor"
                                        rows="8"
                                        minlength="30"
                                        maxlength="4096"
                                        v-model="content"
                                        required
                                        @keyup="onKeyupListener($event)"></textarea>
                                </div>
                                <div class="buttons pt-2">
                                    <button class="next" disabled>ä¸‹ä¸€æ­¥</button>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!-- Step 1 - ç·¨è¼¯æ–‡ç« å…§å®¹ End -->

                    <!-- Step 2 - é¸æ“‡ä¸»é¡Œæ¨£å¼ Start -->
                    <li ref="listItem" class="listItem">
                        <div class="col1">
                            <span class="step">
                                <span>2</span>
                                <span class="checkmark"></span>
                            </span>
                            <span class="line"></span>
                        </div>
                        <div ref="stepBody" class="col2 stepBody">
                            <div class="stepTitle">
                                Step 2 - é¸æ“‡ä¸»é¡Œæ¨£å¼
                            </div>
                            <div class="row mt-2">
                                <div class="col-6 col-md-4 col-lg-3 p-1" v-for="theme in themes" v-bind:key="theme">
                                    <input type="radio" name="theme" :id="theme" v-model="selector.theme" v-bind:value="theme">
                                    <label :for="theme">
                                        <img :src="`/img/frontend/article/theme/${theme}.png`" class="img-fluid rounded">
                                    </label>
                                </div>
                            </div>
                            <div class="content">
                                <div class="buttons pt-2">
                                    <button class="next">ä¸‹ä¸€æ­¥</button>
                                    <button class="prev">è¿”å›</button>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!-- Step 2 - é¸æ“‡ä¸»é¡Œæ¨£å¼ End -->

                    <!-- Step 3 - é¸æ“‡å­—å‹æ¨£å¼ Start -->
                    <li ref="listItem" class="listItem">
                        <div class="col1">
                            <span class="step">
                                <span>3</span>
                                <span class="checkmark"></span>
                            </span>
                            <span class="line"></span>
                        </div>
                        <div ref="stepBody" class="col2 stepBody">
                            <div class="stepTitle">
                                Step 3 - é¸æ“‡å­—å‹æ¨£å¼
                            </div>
                            <div class="row mt-2">
                                <div class="col-6 col-md-4 col-lg-3 p-1" v-for="font in fonts" v-bind:key="font">
                                    <input type="radio" name="font" :id="font" v-model="selector.font" v-bind:value="font">
                                    <label :for="font">
                                        <img :src="`/img/frontend/article/font/${font}.png`" class="img-fluid rounded" />
                                    </label>
                                </div>
                            </div>
                            <div class="content">
                                <div class="buttons pt-2">
                                    <button class="next">ä¸‹ä¸€æ­¥</button>
                                    <button class="prev">è¿”å›</button>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!-- Step 3 - é¸æ“‡å­—å‹æ¨£å¼ End -->

                    <!-- Step 4 - åŒæ„ç‰ˆè¦ Start -->
                    <li ref="listItem" class="listItem">
                        <div class="col1">
                            <span class="step">
                                <span>4</span>
                                <span class="checkmark"></span>
                            </span>
                            <span class="line"></span>
                        </div>
                        <div ref="stepBody" class="col2 stepBody">
                            <div class="stepTitle">
                                Step 4 - åŒæ„ç‰ˆè¦
                            </div>
                            <div class="jumbotron jumbotron-fluid rounded p-2 mt-2">
                                <div class="container p-0">
                                    <h1 class="text-center w-100 py-2 my-0">å…§å®¹å®ˆå‰‡</h1>
                                    <h3>ä¸€ã€è²¬ä»»è²æ˜ï¼š</h3>
                                    <p>æœ¬ç«™ä½¿ç”¨è€…é ˆå°è‡ªå·±æ‰€å¼µè²¼ä¹‹æ¯ä¸€ç¯‡æ–‡ç« è² è²¬ï¼Œæœ¬ç«™æ¯‹éœ€å°ç«™å…§ä»¥åŠå…¶ä»–é—œè¯ä¹‹ç¤¾ç¾¤åª’é«”çš„è¨€è«–è² æ“”èµ·ä»»ä½•çš„è²¬ä»»ï¼Œè²¬ä»»çš„æ­¸å±¬æ¬Šå±¬æ–¼å„ä½ç™¼è¡¨äººã€‚</p>
                                    <h3>äºŒã€ç™¼è¡¨æ–‡ç« æ™‚ä¹‹æ³¨æ„äº‹é …ï¼š</h3>
                                    <ol class="pb-2">
                                        <li>å°Šé‡ä»–äººæ„è¦‹ï¼Œæ³¨æ„ç”¨å­—é£è©èˆ‡å£æ°£ï¼Œé¿å…å¼•èµ·çˆ­åµã€‚</li>
                                        <li>é¿å…åœ¨å…¬çœ¾å€åŸŸï¼Œè¨è«–ç§äººäº‹å‹™ã€‚</li>
                                        <li>é¿å…ç™¼è¡¨æ–‡ç« æ–¼éç›¸é—œå€åŸŸï¼Œæ–‡ç« æ¨™é¡ŒåŠå…§å®¹ä¸ç¬¦åˆè¨è«–å€ä¹‹è¨è«–ä¸»é¡Œã€‚</li>
                                        <li>ç¦æ­¢é‡è¤‡åˆŠç™»ç›¸åŒå…§å®¹æˆ–ç›¸åŒæ„ç¾©ä¹‹ç•™è¨€ã€‚</li>
                                        <li>é©åº¦å¼•ç”¨æ–‡ç« ï¼Œé¿å…å¼•ç”¨éé•·æ–‡ç« ï¼Œé€ æˆé–±è®€å›°æ“¾ã€‚</li>
                                        <li>ä¸é©ç•¶çš„å»£å‘Šã€å®£å‚³æ´»å‹•æˆ–å•†æ¥­æ€§ç•™è¨€ã€‚</li>
                                        <li>ç¦æ­¢ç™¼è¡¨è¬¾ç½µã€è„…è¿«ã€æŒ‘é‡ã€çŒ¥è¤»æˆ–ä¸é›…ä¹‹æ–‡å­—ã€‚</li>
                                        <li>ç¦æ­¢ç™¼è¡¨å€‹äººæ¸¬è©¦ç”¨æ–‡ç« æˆ–æ•£æ’­ä¸å¯¦æ¶ˆæ¯ä¹‹æ–‡ç« ï¼Œå¼µè²¼æ–‡ç« ï¼Œæ‡‰è‡ªè² ç›¸é—œæ³•å¾‹è²¬ä»»ã€‚</li>
                                        <li>è½‰è²¼ä»»ä½•æ–‡ç« è«‹é™„ä¸ŠåŸä½œè€…è²¨ä¾†æºï¼Œå¦å‰‡ç‰ˆä¸»æœƒè¦ªè‡ªå»å•æˆæ¬Šã€è™•ç†æ–¹å¼ï¼Œä¸¦ä¸”æŠŠæ‚¨çš„å¸³è™Ÿå°é–ã€‚</li>
                                        <li>ç¦æ­¢ä»¥ç™¼è¡¨é˜²ç–«ç›¸é—œçš„èª¿ä¾ƒã€åé˜²ç–«ç›¸é—œè¨€è«–ã€‚</li>
                                        <li>è‹¥æœ‰æœªè¦å®šçš„éƒ¨ä»½ï¼Œç”±ç‰ˆä¸»ä¾ä¸»è§€èªå®šï¼Œè¦–æƒ…æ³è™•ç†ã€‚</li>
                                    </ol>
                                    <h3>ä¸‰ã€é•è¦è™•ç†è¾¦æ³•ï¼š</h3>
                                    <p>é•åä¸Šè¿°è¦å®šä¹‹æ–‡ç« æˆ–ä½œè€…ï¼Œç‰ˆä¸»å¯åˆªé™¤æ–‡ç« æˆ–è¡Œä½¿ç¦è²¼ä¹‹è™•ä»½ã€‚</p>
                                    <h3>å››ã€é™„è¨»åŠè£œå……èªªæ˜ï¼š</h3>
                                    <ol class="pb-2">
                                        <li>æœ¬ç«™æ­¡è¿ç¶²å‹äº’ç›¸è¨è«–ç™¼è¡¨å·±è¦‹ï¼Œå”¯è«‹å‹™å¿…éµå®ˆä¸Šè¿°è¦å®šã€‚</li>
                                        <li>æ˜¯å¦é•åä¸Šè¿°è¦å®šï¼Œç”±ç‰ˆä¸»ä¸»è§€èªå®šï¼Œè«‹è¬¹æ…ç”¨è©ã€‚</li>
                                        <li>è«‹å­¸ç¿’åŒ…å®¹å„ç¨®æ„è¦‹ï¼Œå¦‚é‡æƒ¡æ„æ‰¹è©•æˆ–æ”»æ“Šä¹‹æ–‡ç« ï¼Œåˆ‡å‹¿åŠ å…¥çˆ­åŸ·ï¼Œä¸¦ä¸”å–„ç”¨æª¢èˆ‰ï¼Œç‰ˆä¸»æœƒæœ‰é©ç•¶ä¹‹è™•ç†ï¼Œå¦å‰‡é›™æ–¹</li>çš†ä¾ä¸Šè¿°è¦å®šè™•ç†ã€‚
                                    </ol>
                                </div>
                                <div class="mt-2 text-center">
                                    <input class="tgl tgl-flip" id="consent" type="checkbox" v-model="consent"/>
                                    <label style="display: inline-block;" class="tgl-btn mt-2 mr-2" data-tg-off="æ°å“¥ä¸è¦ï¼ğŸ˜±" data-tg-on="å¥½ã„›ğŸ¥´" for="consent"></label>
                                    <label style="display: inline-block;" :class="[consent ? 'text-success' : 'text-danger']" for="consent">
                                        {{ consent ? 'æˆ‘çœ‹å®Œäº†ï¼Œæˆ‘é¡˜æ„éµå®ˆä»¥ä¸Šçš„å…§å®¹å®ˆå‰‡ï¼Œæ‰€ä»¥æˆ‘æŒ‰äº†ã€Œå¥½ã„›ğŸ¥´ã€ä»¥è¡¨ç¤ºæˆ‘åŒæ„ã€‚' : 'æ°å“¥ï¼Œä¸è¦å•¦ï¼æ°å“¥ä¸è¦ï¼æˆ‘ä¸æƒ³éµå®ˆã€Œå…§å®¹å®ˆå‰‡ã€ğŸ˜­' }}
                                    </label>
                                </div>
                                <div class="buttons pt-2">
                                    <button class="next" :disabled="!consent">ä¸‹ä¸€æ­¥</button>
                                    <button class="prev" style="background-color: var(--background-secondary);">è¿”å›</button>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!-- Step 4 - åŒæ„ç‰ˆè¦ End -->

                    <!-- Step 5 - æœ€å¾Œç¢ºèª Start -->
                    <li ref="listItem" class="listItem">
                        <div class="col1">
                            <span class="step">
                                <span>5</span>
                                <span class="checkmark"></span>
                            </span>
                            <span class="line"></span>
                        </div>
                        <div ref="stepBody" class="col2 stepBody">
                            <div class="stepTitle">
                                Step 5 - æœ€å¾Œç¢ºèª
                            </div>
                            <div class="content">
                                <div class="inputGroup">
                                    <p>å¥½æ£’ï¼Œæ¥ä¸‹ä¾†æˆ‘å€‘åªè¦ã€Œé€å‡ºæŠ•ç¨¿ã€å°±å¯ä»¥äº†ï¼</p>
                                </div>
                                <div class="buttons pt-2">
                                    <button type="button"
                                        class="submit btn yes"
                                        @click="submitForm()"
                                        :disabled="final !== null">
                                        <div v-if="final === null">
                                            é€å‡ºæŠ•ç¨¿
                                        </div>
                                        <div v-else>
                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                    </button>
                                    <button class="prev" v-if="final === null">è¿”å›</button>
                                </div>
                                <div class="message">
                                    <span class="success">æ‚¨æˆåŠŸé€å‡ºæŠ•ç¨¿äº†ï¼Œ</span>
                                    <span class="fail">å•Šï¼Ÿå¥½åƒæœ‰äº›åœ°æ–¹ä¸å¤ªå°å‹ ...</span>
                                </div>
                            </div>
                        </div>
                    </li>
                    <!-- Step 5 - æœ€å¾Œç¢ºèª End -->
                </ul>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    name: "PublishArticle",
    data() {
        return {
            stepsWrapper: null,
            listItems: null,
            inputs: null,
            content: null,
            consent: false,
            final: null,
            selector: {
                theme: 'black-green',
                font: 'auraka',
            },
            themes: [
                'black-green',
                'black-yellow',
                'black-white',
                'black-red',
                'sweet-panda',
                'blue-white',
                'white-blue',
                'laravel',
                'soft-green',
                'grey-pikachu',
                'grey-eevee',
                'pikachu-grey',
                'eevee-grey',
                'chinese-new-year',
                'reverse-chinese-new-year',
                'devotion',
                'windows-10-error',
                'windows-10-error-testing',
                'pink',
                'broken-think',
                'furry-broken-think',
            ],
            fonts: [
                'auraka',
                'kc24m',
                'microsoft-jheng-hei',
                'mingliu',
                'kaiu',
                'fot-matissepro-eb',
                'taipei-sans-tc-beta-bold',
            ],
        };
    },
    mounted() {
        this.stepsWrapper = document.querySelector(".steps")
        this.listItems = this.stepsWrapper.querySelectorAll(".listItem")
        this.inputs = this.stepsWrapper.querySelectorAll("input")

        // é è¨­æ‰“é–‹ Step 1
        this.listItems[0].style.height = '630px';
    },
    methods: {
        onKeyupListener(e) {
            // ç”¨ keyup ç‚ºæ¯å€‹ input æ·»åŠ ç„¦é»
            const inputWrapper = e.target.closest(".inputGroup");
            const nextButton = inputWrapper
                .closest(".stepBody")
                .querySelector(".next");

            // å¦‚æœæ˜¯åŒæ„å…§å®¹å®ˆå‰‡ï¼Œå…§å®¹å®ˆå‰‡è¢«åŒæ„äº†å‰‡å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
            if (this.consent) {
                console.log('åŒæ„å…§å®¹å®ˆå‰‡');
                return (nextButton.disabled = false);
            }

            // å¦‚æœæ²’æœ‰ valueï¼Œå‰‡ç§»é™¤ç„¦é»ï¼Œç¦ç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•ä¸¦ return
            if (!e.target.value) {
                console.log('æ²’æœ‰ value');
                inputWrapper.closest(".listItem").classList.remove("done");
                inputWrapper.classList.remove("js-focus");
                return (nextButton.disabled = true);
            }
            inputWrapper.classList.add("js-focus");

            // å¦‚æœä»æœ‰è¼¸å…¥ç‚ºç©ºï¼Œå‰‡ç¦ç”¨ä¸‹ä¸€å€‹æŒ‰éˆ•
            if (inputWrapper.nextElementSibling.classList.contains("inputGroup") &&
               !inputWrapper.nextElementSibling.querySelector("input").value) {
                console.log('è¼¸å…¥ç‚ºç©º');
                return;
            }

            if (this.content.length < 30) {
                console.log('content.length < 30');
                return;
            }

            console.log('å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•');
            // å¦å‰‡å•Ÿç”¨ä¸‹ä¸€æ­¥æŒ‰éˆ•
            nextButton.disabled = false;
        },
        onClickListener(e) {
            // å¦‚æœå–®æ“Šä¸åœ¨æŒ‰éˆ•ä¸Šï¼Œå‰‡è¿”å›
            if (!e.target.closest("button")) {
                return;
            }

            const btn = e.target;
            const currentStep = btn.closest(".listItem");

            btn.classList.contains("next")
                ? this.changeSteps(currentStep, currentStep.nextElementSibling)
                : btn.classList.contains("prev")
                    ? this.changeSteps(currentStep, currentStep.previousElementSibling)
                    : this.submitForm(btn);
        },
        changeSteps(currentStep, newStep) {
            // 1. é—œé–‰ç•¶å‰æ­¥é©Ÿ
            currentStep.style.height = getComputedStyle(newStep).height; // ç²å–ï¼ˆå°šæœªï¼‰é—œé–‰ä¸‹ä¸€æ­¥çš„é«˜åº¦
            currentStep.classList.remove("show");
            // å¦‚æœæŒ‰ä¸‹ç¹¼çºŒæŒ‰éˆ•ï¼Œå‰‡æ·»åŠ è¤‡é¸æ¨™è¨˜
            if (newStep === currentStep.nextElementSibling)
                currentStep.classList.add("done");

            // 2. æ‰“é–‹ä¸‹ä¸€æ­¥
            const contentHeight = newStep
                .querySelector(".stepBody")
                .getBoundingClientRect().height;
            newStep.style.height = `${contentHeight}px`;
            newStep.classList.add("show");
        },
        submitForm(btn) {
            // æäº¤æ™‚é¡¯ç¤ºæˆåŠŸä¿¡æ¯
            // btn.closest(".buttons").nextElementSibling.classList.add("success");
            // éš±è— back æŒ‰éˆ•
            // btn.nextElementSibling.style.display = "none";
            this.final = 'submit';

            let vm = this;
            let data = {
                content: vm.content,
                theme: vm.selector.theme,
                font: vm.selector.font,
            };
            axios.post(`/api/social/cards/publish/article`, data)
                .then(function (response) {
                    vm.final = 'success';
                    // æˆåŠŸæŠ•ç¨¿æ–‡ç« 
                    // éœ€è¦åƒèˆ‡ç¾¤çœ¾å¯©æ ¸çš„å°å¼•
                })
                .catch(function (error) {
                    vm.final = 'error';
                    // ç„¡æ³•æŠ“å–æŠ•ç¥¨è³‡è¨Š
                    // éœ€è¦æœ‰å€‹ Error æç¤ºè¨Šæ¯
                });
        },
    },
};
</script>
